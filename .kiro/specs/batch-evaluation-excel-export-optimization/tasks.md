# Implementation Plan: 批量评估Excel导出优化

## Overview

本实施计划将批量评估模块的Excel导出功能优化分解为可执行的编码任务。优化包括：数据完整性增强、新增统计工作表、样式统一、图表优化、性能提升和向后兼容性保障。

实施策略：
1. 先优化现有工作表（补全数据、统一样式）
2. 再新增统计工作表
3. 最后优化性能和测试

## Tasks

- [x] 1. 创建数据提取模块
  - [x] 1.1 实现 DataExtractor 类的基础结构
    - 创建 `services/excel_export_service.py` 文件
    - 定义 DataExtractor 类和基础方法签名
    - _Requirements: 1.1, 1.2, 1.3_
  
  - [x] 1.2 实现错误详情完整提取方法
    - 实现 `extract_error_details()` 方法
    - 从基准效果和AI结果中提取完整字段
    - 处理相似度、严重程度等可选字段
    - _Requirements: 1.1, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  
  - [ ]* 1.3 为错误详情提取编写属性测试
    - **Property 1: 错误详情字段完整性**
    - **Property 18: 错误详情对比信息完整性**
    - **Validates: Requirements 1.1, 6.1-6.7**
  
  - [x] 1.4 实现学生统计数据提取方法
    - 实现 `extract_student_statistics()` 方法
    - 按学生聚合作业数据
    - 计算各题型准确率
    - _Requirements: 2.2_
  
  - [ ]* 1.5 为学生统计提取编写属性测试
    - **Property 9: 统计表字段完整性**
    - **Validates: Requirements 2.2**
  
  - [x] 1.6 实现页码统计数据提取方法
    - 实现 `extract_page_statistics()` 方法
    - 按页码聚合作业数据
    - 统计错误类型分布
    - _Requirements: 2.4_
  
  - [x] 1.7 实现题型统计数据提取方法
    - 实现 `extract_type_statistics()` 方法
    - 按题型聚合数据
    - 统计错误类型分布
    - _Requirements: 2.6_
  
  - [x] 1.8 实现英语作文评分提取方法
    - 实现 `extract_essay_scores()` 方法
    - 解析作文评分数据（得分、评价、建议）
    - 计算统计数据（平均分、最高分、最低分、分布）
    - _Requirements: 1.5, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8_
  
  - [ ]* 1.9 为作文评分提取编写属性测试
    - **Property 5: 英语作文评分提取准确性**
    - **Property 10: 英语作文工作表条件创建**
    - **Validates: Requirements 1.5, 2.7, 8.1-8.8**
  
  - [x] 1.10 实现数据集信息提取方法
    - 实现 `extract_dataset_info()` 方法
    - 从任务数据中提取数据集信息
    - 处理多数据集场景
    - _Requirements: 1.4, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x] 2. 创建样式配置模块
  - [x] 2.1 实现 StyleConfig 类
    - 定义黑白简洁配色方案
    - 定义字体、填充、对齐、边框样式
    - 实现条件格式应用方法
    - _Requirements: 3.1, 3.2, 3.3_
  
  - [ ]* 2.2 为样式配置编写单元测试
    - 测试颜色定义正确性
    - 测试条件格式应用逻辑
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 3. 优化现有工作表
  - [x] 3.1 优化评估总结表
    - 添加数据集信息部分
    - 统一样式为黑白简洁风格
    - 添加筛选器和冻结窗格
    - _Requirements: 1.4, 3.1, 3.2, 3.4, 3.5, 7.1-7.7_
  
  - [x] 3.2 优化错误详情表
    - 补全所有字段（基准答案、AI答案、判断结果）
    - 添加相似度和严重程度字段
    - 统一样式和对齐方式
    - _Requirements: 1.1, 1.6, 6.1-6.7, 3.7, 3.8_
  
  - [x] 3.3 优化题目明细表
    - 添加题型分类字段
    - 添加标准答案、判断结果字段
    - 添加相似度和错误类型字段
    - _Requirements: 1.7, 5.1-5.7_
  
  - [x] 3.4 优化作业明细表
    - 添加数据集名称字段
    - 统一样式和条件格式
    - _Requirements: 3.3, 7.7_
  
  - [ ]* 3.5 为现有工作表优化编写属性测试
    - **Property 2: 学生信息传播一致性**
    - **Property 3: 作业ID传播完整性**
    - **Property 4: 数据集信息展示完整性**
    - **Property 17: 题目明细字段完整性**
    - **Validates: Requirements 1.2, 1.3, 1.4, 5.1-5.7, 7.1-7.7**

- [x] 4. 创建新增统计工作表
  - [x] 4.1 实现按学生统计工作表生成器
    - 创建 `create_student_statistics_sheet()` 方法
    - 设置表头和样式
    - 填充学生统计数据
    - 添加准确率趋势折线图
    - _Requirements: 2.1, 2.2, 4.4_
  
  - [x] 4.2 实现按页码统计工作表生成器
    - 创建 `create_page_statistics_sheet()` 方法
    - 设置表头和样式
    - 填充页码统计数据
    - 添加错误分布柱状图
    - _Requirements: 2.3, 2.4, 4.5_
  
  - [x] 4.3 实现按题型统计工作表生成器
    - 创建 `create_type_statistics_sheet()` 方法
    - 设置表头和样式
    - 填充题型统计数据
    - 添加准确率对比柱状图
    - _Requirements: 2.5, 2.6, 4.3_
  
  - [x] 4.4 实现英语作文评分工作表生成器
    - 创建 `create_essay_scores_sheet()` 方法
    - 设置表头和样式
    - 填充作文评分数据
    - 添加得分分布统计
    - _Requirements: 2.7, 2.8, 8.1-8.8_
  
  - [ ]* 4.5 为新增工作表编写属性测试
    - **Property 8: 工作表创建完整性**
    - **Property 9: 统计表字段完整性**
    - **Property 10: 英语作文工作表条件创建**
    - **Validates: Requirements 2.1-2.8**

- [x] 5. 优化图表生成
  - [x] 5.1 实现 ChartGenerator 类
    - 创建图表生成器基础结构
    - 实现数据点限制方法
    - _Requirements: 4.1, 9.2_
  
  - [x] 5.2 实现各类图表创建方法
    - 实现饼图创建方法
    - 实现柱状图创建方法
    - 实现折线图创建方法
    - 实现雷达图创建方法
    - 统一图表样式为黑白简洁风格
    - _Requirements: 4.2, 4.3, 4.4, 4.5, 4.7_
  
  - [x] 5.3 实现图表位置优化
    - 将图表放置在数据表右侧或下方
    - 避免图表遮挡数据
    - _Requirements: 4.1_
  
  - [x] 5.4 实现空数据图表跳过逻辑
    - 检查图表数据是否为空
    - 空数据时跳过图表创建
    - _Requirements: 4.6_
  
  - [ ]* 5.5 为图表生成编写属性测试
    - **Property 15: 图表位置合理性**
    - **Property 16: 空数据图表跳过**
    - **Property 19: 图表数据点限制**
    - **Validates: Requirements 4.1, 4.6, 9.2**

- [x] 6. 实现性能优化
  - [x] 6.1 实现批量写入优化
    - 创建 `batch_write_rows()` 方法
    - 使用批量写入减少IO操作
    - _Requirements: 9.1_
  
  - [x] 6.2 实现内存优化
    - 创建 `stream_write_large_data()` 方法
    - 使用流式处理大数据
    - 定期清理内存
    - _Requirements: 9.3_
  
  - [x] 6.3 实现延迟计算
    - 创建 `lazy_extract_data()` 方法
    - 只在需要时计算数据
    - _Requirements: 9.1_

- [x] 7. 实现向后兼容性
  - [x] 7.1 实现安全数据获取方法
    - 创建 `safe_get()` 方法
    - 创建 `safe_get_nested()` 方法
    - 创建 `get_with_fallback()` 方法
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  
  - [x] 7.2 实现数据类型转换方法
    - 创建 `safe_float()` 方法
    - 创建 `safe_int()` 方法
    - 创建 `safe_json_loads()` 方法
    - _Requirements: 10.6_
  
  - [x] 7.3 实现数据结构标准化方法
    - 创建 `normalize_homework_result()` 方法
    - 兼容旧数据格式
    - _Requirements: 10.2, 10.6_
  
  - [ ]* 7.4 为向后兼容性编写属性测试
    - **Property 21: 向后兼容性 - 缺失字段处理**
    - **Validates: Requirements 10.1-10.7**

- [x] 8. 更新主导出函数
  - [x] 8.1 重构 export_batch_excel 函数
    - 集成新的数据提取模块
    - 集成新的样式配置
    - 集成新的工作表生成器
    - _Requirements: All_
  
  - [x] 8.2 添加错误处理
    - 捕获所有异常
    - 返回明确的错误信息
    - 记录导出日志
    - _Requirements: 9.5, 9.6_
  
  - [x] 8.3 添加导出元数据
    - 在Excel中添加版本信息
    - 添加导出时间戳
    - _Requirements: 10.7_
  
  - [ ]* 8.4 为主导出函数编写集成测试
    - 测试完整导出流程
    - 测试各种数据场景
    - 测试错误处理
    - _Requirements: All_

- [x] 9. 样式和格式优化
  - [x] 9.1 统一所有工作表样式
    - 应用黑白简洁配色方案
    - 统一表头样式
    - 统一边框样式
    - _Requirements: 3.1, 3.2_
  
  - [x] 9.2 应用条件格式
    - 为准确率单元格应用条件格式
    - 为错误类型单元格应用颜色标记
    - _Requirements: 3.3_
  
  - [x] 9.3 优化列宽和对齐
    - 根据内容自动调整列宽
    - 数值使用居中对齐
    - 长文本使用自动换行
    - _Requirements: 3.6, 3.7, 3.8_
  
  - [x] 9.4 添加表格功能
    - 为所有工作表添加筛选器
    - 冻结首行表头
    - _Requirements: 3.4, 3.5_
  
  - [ ]* 9.5 为样式和格式编写属性测试
    - **Property 11: 样式一致性**
    - **Property 12: 准确率条件格式正确性**
    - **Property 13: 表格功能完整性**
    - **Property 14: 数值对齐一致性**
    - **Validates: Requirements 3.1-3.8**

- [ ] 10. 测试和验证
  - [ ]* 10.1 编写数据提取单元测试
    - 测试各种数据格式
    - 测试边界条件
    - 测试缺失字段处理
    - _Requirements: All_
  
  - [ ]* 10.2 编写工作表生成单元测试
    - 测试各工作表创建
    - 测试数据填充
    - 测试样式应用
    - _Requirements: All_
  
  - [ ]* 10.3 编写性能测试
    - 测试1000条作业数据导出
    - 测试10000条题目数据导出
    - 监控内存使用
    - _Requirements: 9.1, 9.3_
  
  - [ ]* 10.4 编写向后兼容性测试
    - 测试旧任务数据导出
    - 测试缺失字段场景
    - 测试数据格式兼容
    - _Requirements: 10.1-10.7_

- [ ] 11. Checkpoint - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试
  - 修复发现的问题
  - 如有疑问，询问用户

- [ ] 12. 文档和部署
  - [ ] 12.1 更新API文档
    - 更新导出接口说明
    - 添加新增工作表说明
    - 添加使用示例
    - _Requirements: All_
  
  - [ ] 12.2 更新用户指南
    - 添加新功能说明
    - 添加Excel报告解读指南
    - _Requirements: All_
  
  - [ ] 12.3 准备部署
    - 确认所有依赖已安装
    - 运行部署前测试
    - 准备回滚方案
    - _Requirements: All_

## Notes

- 所有标记 `*` 的任务为可选测试任务，可根据项目进度决定是否执行
- 每个任务都引用了对应的需求编号，便于追溯
- 属性测试配置为最少运行100次迭代
- 集成测试应覆盖各种数据场景（英语作文、语文模糊匹配、旧数据等）
- 性能测试应在接近生产环境的配置下运行
- 部署前必须通过所有核心测试

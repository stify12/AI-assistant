<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量评估</title>
    <!-- DNS 预连接 CDN -->
    <link rel="preconnect" href="https://cdn.bootcdn.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.bootcdn.net">
    <!-- 预加载关键资源 -->
    <link rel="preload" href="/static/css/common.css?v=20260125" as="style">
    <link rel="preload" href="/static/css/batch-evaluation.css?v=20260128" as="style">
    <!-- 样式表 -->
    <link rel="stylesheet" href="/static/css/common.css?v=20260125">
    <link rel="stylesheet" href="/static/css/batch-evaluation.css?v=20260128">
    <!-- Chart.js 和 html2canvas 改为按需加载，不在首屏加载 -->
    <!-- 首屏关键CSS -->
    <style>
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
        .loading-overlay.show{display:flex}
        .loading-container{text-align:center}
        .loading-icon{width:48px;height:48px;margin:0 auto 16px}
        .loading-icon-circle{width:100%;height:100%;border:3px solid #e5e5e5;border-top-color:#1d1d1f;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">批量评估</div>
        <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn btn-secondary" onclick="showPromptConfigModal()">提示词配置</button>
            <button class="btn btn-secondary" onclick="showSettingsModal()">设置</button>
            <button class="back-btn" onclick="goBack()">返回</button>
        </div>
    </nav>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-icon">
                <div class="loading-icon-circle"></div>
                <div class="loading-icon-arc"></div>
            </div>
            <div class="loading-progress-wrapper">
                <div class="loading-text" id="loadingText">处理中...</div>
                <div class="loading-progress-track">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
                <div class="loading-subtext" id="loadingSubtext"></div>
            </div>
        </div>
    </div>

    <!-- Tab切换 -->
    <div class="tab-container">
        <div class="tabs">
            <div class="tab active" data-tab="tasks">任务管理</div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-layout">
        <!-- 任务管理视图 -->
        <div class="view-container" id="tasksView">
            <!-- 左侧面板 - 任务列表 -->
            <div class="left-panel">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">评估任务</div>
                        <button class="btn btn-primary" onclick="showCreateTaskModal()">新建任务</button>
                    </div>
                    <!-- 学科筛选下拉 + 测试条件筛选 -->
                    <div class="filter-row" style="margin-bottom: 12px;">
                        <div class="form-group" style="flex: 1;">
                            <label>学科筛选</label>
                            <select id="taskSubjectFilter" onchange="onTaskFilterChange()">
                                <option value="">全部学科</option>
                                <option value="0">英语</option>
                                <option value="1">语文</option>
                                <option value="2">数学</option>
                                <option value="3">物理</option>
                                <option value="4">化学</option>
                                <option value="5">生物</option>
                                <option value="6">地理</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>测试条件</label>
                            <select id="taskConditionFilter" onchange="onTaskFilterChange()">
                                <option value="">全部条件</option>
                            </select>
                        </div>
                    </div>
                    <div class="task-list" id="taskList">
                        <div class="empty-state">
                            <div class="empty-state-icon">--</div>
                            <div class="empty-state-text">暂无评估任务</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板 - 任务详情 -->
            <div class="right-panel">
                <div class="empty-right-panel" id="emptyTaskDetail">
                    <div class="empty-state">
                        <div class="empty-state-icon">--</div>
                        <div class="empty-state-text">请从左侧选择任务</div>
                    </div>
                </div>
                <div class="task-detail" id="taskDetail" style="display:none;">
                    <div class="section">
                        <div class="section-header">
                            <div>
                                <div class="section-title" id="taskDetailTitle">任务详情</div>
                                <div class="section-desc" id="taskDetailMeta"></div>
                                <div class="task-collection-row" id="taskCollectionRow" style="display:none;">
                                    <span class="task-collection-label">已应用合集:</span>
                                    <span class="task-collection-name" id="taskCollectionName"></span>
                                </div>
                                <div class="task-remark-row" id="taskRemarkRow" style="display:none;">
                                    <span class="task-remark-text" id="taskRemarkText"></span>
                                    <button class="btn-edit-remark" onclick="showRemarkModal()">编辑</button>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-primary" id="batchAiEvalBtn" onclick="batchAiEvaluation()">一键AI评估</button>
                                <button class="btn btn-secondary" id="startEvalBtn" onclick="startBatchEvaluation()">开始分析</button>
                                <button class="btn btn-secondary" id="aiReportBtn" onclick="generateAIReport()" disabled>AI分析任务</button>
                                <button class="btn btn-secondary" id="viewAnalysisBtn" onclick="viewAnalysisReport()" disabled>查看分析</button>
                                <div class="more-actions-dropdown">
                                    <button class="btn btn-secondary" id="moreActionsBtn" onclick="toggleMoreActions(event)">
                                        更多
                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="margin-left: 4px;">
                                            <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <div class="more-actions-menu" id="moreActionsMenu">
                                        <button class="menu-item" id="reEvalBtn" onclick="reEvaluateCurrentTask(); hideMoreActions();">重新评估</button>
                                        <button class="menu-item" id="exportBtn" onclick="exportExcel(); hideMoreActions();" disabled>导出Excel</button>
                                        <button class="menu-item" id="resetTaskBtn" onclick="resetBatchTask(); hideMoreActions();" style="display:none;">重置任务</button>
                                        <div class="menu-divider"></div>
                                        <button class="menu-item menu-item-danger" onclick="deleteCurrentTask(); hideMoreActions();">删除任务</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 评估进度 -->
                        <div class="progress-container" id="progressContainer" style="display:none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0/0</div>
                        </div>

                        <!-- 总体报告 -->
                        <div class="overall-report" id="overallReport" style="display:none;">
                            <!-- 测试条件信息 -->
                            <div class="test-conditions-info" id="testConditionsInfo" style="display:none;"></div>
                            
                            <!-- 提示词版本信息 -->
                            <div class="prompt-versions-info" id="promptVersionsInfo" style="display:none;">
                                <div class="prompt-versions-header">
                                    <span class="prompt-versions-label">使用的提示词版本</span>
                                    <div class="prompt-versions-tags" id="promptVersionsTags"></div>
                                    <button class="btn btn-small btn-secondary" onclick="showPromptConfigModal()">查看配置</button>
                                </div>
                            </div>
                            
                            <div class="report-title">总体报告</div>
                            <div class="stats-grid" id="overallStats"></div>
                            
                            <!-- 可视化图表 -->
                            <div class="charts-container" id="chartsContainer">
                                <div class="chart-grid">
                                    <div class="chart-box">
                                        <div class="chart-title">错误类型分布</div>
                                        <canvas id="errorTypePieChart"></canvas>
                                    </div>
                                    <div class="chart-box anomaly-chart-box" id="anomalyChartBox" onclick="showAnomalyDetailModal()">
                                        <div class="chart-title">
                                            <span>异常检测</span>
                                            <span class="chart-link">查看详情</span>
                                        </div>
                                        <div class="anomaly-summary" id="anomalySummary">
                                            <div class="anomaly-stats-row">
                                                <div class="anomaly-stat-card anomaly-universal">
                                                    <div class="anomaly-stat-value" id="anomalyUniversalCount">-</div>
                                                    <div class="anomaly-stat-label">全员错误</div>
                                                </div>
                                                <div class="anomaly-stat-card anomaly-high">
                                                    <div class="anomaly-stat-value" id="anomalyHighAnomalyCount">-</div>
                                                    <div class="anomaly-stat-label">高异常</div>
                                                </div>
                                                <div class="anomaly-stat-card anomaly-low">
                                                    <div class="anomaly-stat-value" id="anomalyLowAnomalyCount">-</div>
                                                    <div class="anomaly-stat-label">低异常</div>
                                                </div>
                                                <div class="anomaly-stat-card anomaly-normal">
                                                    <div class="anomaly-stat-value" id="anomalyNormalCount">-</div>
                                                    <div class="anomaly-stat-label">一致</div>
                                                </div>
                                            </div>
                                            <div class="anomaly-progress-row">
                                                <div class="anomaly-rate" id="anomalyRate">-</div>
                                                <div class="anomaly-bar-wrap">
                                                    <div class="anomaly-segmented-bar" id="anomalySegmentedBar">
                                                        <div class="anomaly-segment segment-universal" id="segmentUniversal" style="width:0%"></div>
                                                        <div class="anomaly-segment segment-high" id="segmentHighAnomaly" style="width:0%"></div>
                                                        <div class="anomaly-segment segment-low" id="segmentLowAnomaly" style="width:0%"></div>
                                                        <div class="anomaly-segment segment-normal" id="segmentNormal" style="width:0%"></div>
                                                    </div>
                                                    <div class="anomaly-stats-text" id="anomalyStatsText">一致 - / 共 - 题</div>
                                                </div>
                                            </div>
                                            <div class="anomaly-preview" id="anomalyPreview">
                                                <span class="anomaly-preview-label">高频异常:</span>
                                                <div class="anomaly-preview-items" id="anomalyPreviewItems">
                                                    <span class="anomaly-preview-empty">暂无数据</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-grid">
                                    <div class="chart-box">
                                        <div class="chart-title">高频错误题目 TOP5</div>
                                        <canvas id="errorTrendChart"></canvas>
                                    </div>
                                    <div class="chart-box">
                                        <div class="chart-title">准确率分析</div>
                                        <div class="accuracy-progress-container" id="accuracyProgressContainer">
                                            <div class="accuracy-progress-item" onclick="showAccuracyDetail('recognition')">
                                                <div class="accuracy-progress-header">
                                                    <span class="accuracy-progress-label">识别准确率</span>
                                                    <span class="accuracy-progress-value" id="recognitionRateValue">-</span>
                                                </div>
                                                <div class="accuracy-progress-bar">
                                                    <div class="accuracy-progress-fill recognition-fill" id="recognitionProgressFill"></div>
                                                </div>
                                                <div class="accuracy-progress-stats" id="recognitionStats">正确 0 / 总计 0</div>
                                            </div>
                                            <div class="accuracy-progress-item" onclick="showAccuracyDetail('grading')">
                                                <div class="accuracy-progress-header">
                                                    <span class="accuracy-progress-label">批改准确率</span>
                                                    <span class="accuracy-progress-value" id="gradingRateValue">-</span>
                                                </div>
                                                <div class="accuracy-progress-bar">
                                                    <div class="accuracy-progress-fill grading-fill" id="gradingProgressFill"></div>
                                                </div>
                                                <div class="accuracy-progress-stats" id="gradingStats">正确 0 / 总计 0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 新增图表区域（仅当有分数数据时显示） -->
                                <div class="chart-grid new-charts-grid" id="newChartsGrid" style="display:none;">
                                    <div class="chart-box">
                                        <div class="chart-title">题型分数准确率对比</div>
                                        <canvas id="questionTypeAccuracyChart"></canvas>
                                    </div>
                                    <div class="chart-box" id="scoreAccuracyChartContainer">
                                        <div class="chart-title">判分准确率</div>
                                        <div class="score-accuracy-wrapper">
                                            <div class="score-chart-container">
                                                <canvas id="scoreAccuracyChart"></canvas>
                                            </div>
                                            <div id="scoreAccuracySummary" class="score-accuracy-summary"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stats-detail" id="statsDetail"></div>
                        </div>

                        <!-- 作业列表 -->
                        <div class="homework-list-container">
                            <div class="list-header-row">
                                <div class="list-header">作业任务列表</div>
                                <button class="btn btn-secondary btn-small" onclick="showApplyCollectionModal()">一键应用合集</button>
                            </div>
                            <div class="homework-list" id="homeworkList"></div>
                        </div>

                        <!-- AI分析报告 -->
                        <div class="ai-report" id="aiReport" style="display:none;">
                            <div class="report-title">AI分析报告</div>
                            <div class="report-content" id="aiReportContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据集管理视图已移至学科评估页面 -->
    </div>

    <!-- 新建任务弹窗 -->
    <div class="modal" id="createTaskModal" onclick="hideModal('createTaskModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>新建评估任务</h3>
                <button class="close-btn" onclick="hideModal('createTaskModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>任务名称</label>
                    <input type="text" id="taskNameInput" placeholder="输入任务名称">
                </div>
                <div class="filter-row">
                    <div class="form-group">
                        <label>学科</label>
                        <select id="hwSubjectFilter" onchange="onSubjectFilterChange()">
                            <option value="">全部学科</option>
                            <option value="0">英语</option>
                            <option value="1">语文</option>
                            <option value="2">数学</option>
                            <option value="3">物理</option>
                            <option value="4">化学</option>
                            <option value="5">生物</option>
                            <option value="6">地理</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>测试条件</label>
                        <div class="condition-select-wrapper">
                            <select id="hwConditionSelect" onchange="onConditionSelectChange()">
                                <option value="">请选择测试条件</option>
                            </select>
                            <div class="condition-add-row" id="conditionAddRow" style="display: none;">
                                <input type="text" id="newConditionInput" placeholder="输入新测试条件名称">
                                <button class="btn btn-small btn-primary" onclick="saveNewCondition()">保存</button>
                                <button class="btn btn-small btn-secondary" onclick="cancelAddCondition()">取消</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="fuzzyThresholdGroup" style="display: none;">
                        <label>模糊匹配阈值</label>
                        <div class="threshold-input-wrapper">
                            <input type="range" id="fuzzyThresholdInput" min="50" max="100" value="85" oninput="updateThresholdDisplay()">
                            <span id="fuzzyThresholdValue">85%</span>
                        </div>
                        <div class="form-hint">语文主观题相似度达到此阈值视为匹配</div>
                    </div>
                    <div class="form-group">
                        <label>时间范围</label>
                        <select id="hwTimeFilter" onchange="onTimeFilterChange()">
                            <option value="1">最近1小时</option>
                            <option value="3">最近3小时</option>
                            <option value="6" selected>最近6小时</option>
                            <option value="12">最近12小时</option>
                            <option value="24">最近24小时</option>
                            <option value="72">最近3天</option>
                            <option value="168">最近7天</option>
                        </select>
                    </div>
                </div>
                
                <!-- 作业任务筛选 -->
                <div class="task-filter-section">
                    <div class="task-filter-header">
                        <span class="task-filter-label">按作业任务筛选（可多选）</span>
                        <button class="btn btn-small btn-secondary" onclick="loadHomeworkTasksForFilter()">刷新任务</button>
                    </div>
                    <div class="task-list" id="hwTaskList">
                        <div class="task-loading">加载中...</div>
                    </div>
                    <!-- 任务统计信息 -->
                    <div id="taskStatsInfo" style="display: none;"></div>
                </div>
                
                <div class="selection-info">
                    <span>已选择 <strong id="selectedCount">0</strong> 个作业</span>
                    <button class="btn btn-small" onclick="selectAllHomework()">全选</button>
                    <button class="btn btn-small btn-secondary" onclick="clearHomeworkSelection()">清空</button>
                </div>
                <div class="homework-select-list" id="homeworkSelectList">
                    <div class="empty-state">
                        <div class="empty-state-text">加载中...</div>
                    </div>
                </div>
                
                <!-- 关联合集选择 -->
                <div class="form-group" style="margin-top: 16px;">
                    <label>关联基准合集（可选）</label>
                    <div class="collection-select-row">
                        <select id="taskCollectionSelect" onchange="onTaskCollectionChange()">
                            <option value="">不使用合集</option>
                        </select>
                        <button class="btn btn-small btn-secondary" onclick="refreshCollectionsForTask()">刷新</button>
                    </div>
                    <div class="form-hint">选择合集后，创建任务时将自动为作业匹配数据集</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('createTaskModal')">取消</button>
                <button class="btn btn-primary" onclick="createTask()">创建任务</button>
            </div>
        </div>
    </div>

    <!-- 添加数据集弹窗 -->
    <div class="modal" id="addDatasetModal" onclick="hideModal('addDatasetModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>添加数据集</h3>
                <button class="close-btn" onclick="hideModal('addDatasetModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择页码</label>
                    <div class="page-select-list" id="pageSelectList"></div>
                </div>
                <div class="form-group">
                    <label>基准效果配置</label>
                    <div class="base-effect-config" id="baseEffectConfig">
                        <div class="empty-state">
                            <div class="empty-state-text">请先选择页码</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('addDatasetModal')">取消</button>
                <button class="btn btn-primary" onclick="saveDataset()">保存数据集</button>
            </div>
        </div>
    </div>

    <!-- 评估详情抽屉 -->
    <div class="drawer" id="evalDetailDrawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 id="evalDetailTitle">评估详情</h3>
                <button class="close-btn" onclick="hideDrawer()">x</button>
            </div>
            <div class="drawer-body" id="evalDetailBody">
                <!-- 评估详情内容 -->
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h3>评估设置</h3>
                <button class="close-btn" onclick="hideSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 模糊匹配阈值设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <div class="settings-section-title">模糊匹配阈值</div>
                        <div class="settings-section-badge">语文主观题</div>
                    </div>
                    <div class="settings-slider-group">
                        <input type="range" id="settingsFuzzyThreshold" class="settings-slider" min="50" max="100" value="85" oninput="updateSettingsThresholdDisplay()">
                        <div class="settings-slider-value" id="settingsFuzzyThresholdValue">85%</div>
                    </div>
                    <div class="settings-hint">相似度达到此阈值视为匹配，不计入错误</div>
                </div>
                
                <!-- 题号前缀设置 -->
                <div class="settings-section">
                    <label class="settings-checkbox-label">
                        <input type="checkbox" id="settingsIgnoreIndexPrefix" class="settings-checkbox" checked>
                        <span class="settings-checkbox-custom"></span>
                        <div class="settings-checkbox-content">
                            <div class="settings-checkbox-title">忽略题号前缀差异</div>
                            <div class="settings-checkbox-desc">如 "(1)答案" 与 "答案" 视为相同</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSettingsModal()">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 数据集选择弹窗 -->
    <div class="modal" id="datasetSelectorModal" onclick="hideModal('datasetSelectorModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>选择数据集</h3>
                <button class="close-btn" onclick="hideModal('datasetSelectorModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="selector-info" id="selectorInfo">
                    <!-- 显示当前作业信息 -->
                </div>
                <!-- 合集快速选择 -->
                <div class="collection-quick-select" id="collectionQuickSelect">
                    <div class="collection-select-header">
                        <span class="collection-select-label">使用基准合集快速匹配</span>
                        <button class="btn btn-small btn-secondary" onclick="showCollectionManager()">管理合集</button>
                    </div>
                    <div class="collection-select-list" id="collectionSelectList">
                        <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                    </div>
                </div>
                <div class="dataset-selector-divider">
                    <span>或选择单个数据集</span>
                </div>
                <div class="dataset-selector-list" id="matchingDatasetList">
                    <div class="empty-state">
                        <div class="empty-state-text">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('datasetSelectorModal')">取消</button>
                <button class="btn btn-primary" id="confirmDatasetBtn" onclick="confirmDatasetSelection()" disabled>确认选择</button>
            </div>
        </div>
    </div>

    <!-- 基准合集管理弹窗 -->
    <div class="modal" id="collectionManagerModal" onclick="hideModal('collectionManagerModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>基准合集管理</h3>
                <button class="close-btn" onclick="hideModal('collectionManagerModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="collection-manager-header">
                    <button class="btn btn-primary" onclick="showCreateCollectionModal()">新建合集</button>
                </div>
                <div class="collection-list" id="collectionManagerList">
                    <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('collectionManagerModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 新建/编辑合集弹窗 -->
    <div class="modal" id="collectionEditModal" onclick="hideModal('collectionEditModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="collectionEditTitle">新建合集</h3>
                <button class="close-btn" onclick="hideModal('collectionEditModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>合集名称 <span class="required">*</span></label>
                    <input type="text" id="collectionNameInput" placeholder="输入合集名称">
                </div>
                <div class="form-group">
                    <label>合集描述</label>
                    <textarea id="collectionDescInput" rows="3" placeholder="输入合集描述（可选）"></textarea>
                </div>
                <div class="form-group" id="collectionDatasetsGroup">
                    <label>包含的数据集</label>
                    <div class="collection-datasets-list" id="collectionDatasetsList">
                        <div class="empty-state"><div class="empty-state-text">暂无数据集</div></div>
                    </div>
                    <button class="btn btn-small btn-secondary" onclick="showAddDatasetToCollectionModal()" style="margin-top: 8px;">添加数据集</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('collectionEditModal')">取消</button>
                <button class="btn btn-primary" onclick="saveCollection()">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加数据集到合集弹窗 -->
    <div class="modal" id="addDatasetToCollectionModal" onclick="hideModal('addDatasetToCollectionModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>添加数据集到合集</h3>
                <button class="close-btn" onclick="hideModal('addDatasetToCollectionModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>搜索数据集</label>
                    <input type="text" id="datasetSearchInput" placeholder="输入数据集名称搜索" oninput="filterDatasetsForCollection()">
                </div>
                <div class="dataset-add-list" id="datasetAddList">
                    <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('addDatasetToCollectionModal')">取消</button>
                <button class="btn btn-primary" onclick="confirmAddDatasetsToCollection()">添加选中</button>
            </div>
        </div>
    </div>

    <!-- 题目类型详情弹窗 -->
    <div class="modal" id="typeDetailModal" onclick="hideTypeDetailModal()">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="typeDetailTitle">题目详情</h3>
                <button class="close-btn" onclick="hideTypeDetailModal()">x</button>
            </div>
            <div class="modal-body" id="typeDetailContent">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI分析报告弹窗 -->
    <div class="modal" id="aiReportModal" onclick="hideAIReportModal()">
        <div class="modal-content modal-xlarge" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>AI 批改效果分析报告</h3>
                <div class="modal-header-actions">
                    <button class="btn btn-small btn-secondary" onclick="regenerateAIReport()">重新分析</button>
                    <button class="close-btn" onclick="hideAIReportModal()">x</button>
                </div>
            </div>
            <div class="modal-body" id="aiReportModalBody">
                <div class="ai-report-loading">
                    <div class="spinner"></div>
                    <div>正在生成分析报告...</div>
                </div>
            </div>
            <div class="modal-footer">
                <span class="report-generated-time" id="reportGeneratedTime"></span>
                <button class="btn btn-secondary" onclick="downloadReportScreenshot()">下载截图</button>
                <button class="btn btn-primary" onclick="hideAIReportModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 备注编辑弹窗 -->
    <div class="modal" id="remarkModal" onclick="hideModal('remarkModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h3>编辑任务信息</h3>
                <button class="close-btn" onclick="hideModal('remarkModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>任务名称</label>
                    <input type="text" id="taskNameEditInput" placeholder="输入任务名称" style="font-size: 15px; color: #1d1d1f;">
                </div>
                <div class="form-group">
                    <label>任务备注</label>
                    <textarea id="remarkInput" rows="5" placeholder="输入任务备注信息..." style="resize: vertical; font-size: 15px; color: #1d1d1f; line-height: 1.6;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('remarkModal')">取消</button>
                <button class="btn btn-primary" onclick="saveTaskInfo()">保存</button>
            </div>
        </div>
    </div>

    <!-- 一键应用合集弹窗 -->
    <div class="modal" id="applyCollectionModal" onclick="hideModal('applyCollectionModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h3>一键应用合集</h3>
                <button class="close-btn" onclick="hideModal('applyCollectionModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="apply-collection-desc">
                    选择一个基准合集，将自动为当前任务的所有作业匹配对应的数据集
                </div>
                <div class="apply-collection-list" id="applyCollectionList">
                    <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                </div>
                <div class="apply-collection-preview" id="applyCollectionPreview" style="display:none;">
                    <div class="preview-title">匹配预览</div>
                    <div class="preview-stats">
                        <span class="preview-stat preview-stat-success">可匹配: <strong id="previewMatchedCount">0</strong></span>
                        <span class="preview-stat preview-stat-warning">无法匹配: <strong id="previewUnmatchedCount">0</strong></span>
                    </div>
                </div>
                <!-- 从当前任务创建合集 -->
                <div class="create-collection-from-task" id="createCollectionFromTask" style="display:none;">
                    <div class="create-collection-divider">
                        <span>或</span>
                    </div>
                    <div class="create-collection-hint">
                        当前任务已有 <strong id="taskMatchedDatasetCount">0</strong> 个作业匹配了数据集
                    </div>
                    <button class="btn btn-secondary" onclick="showCreateCollectionFromTaskModal()">从当前任务创建合集</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('applyCollectionModal')">取消</button>
                <button class="btn btn-primary" id="confirmApplyCollectionBtn" onclick="confirmApplyCollection()" disabled>应用合集</button>
            </div>
        </div>
    </div>

    <!-- 从当前任务创建合集弹窗 -->
    <div class="modal" id="createCollectionFromTaskModal" onclick="hideModal('createCollectionFromTaskModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h3>从当前任务创建合集</h3>
                <button class="close-btn" onclick="hideModal('createCollectionFromTaskModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>合集名称 <span class="required">*</span></label>
                    <input type="text" id="newCollectionFromTaskName" placeholder="输入合集名称">
                </div>
                <div class="form-group">
                    <label>描述（可选）</label>
                    <textarea id="newCollectionFromTaskDesc" rows="2" placeholder="输入描述"></textarea>
                </div>
                <div class="create-collection-info">
                    <div class="info-item">将包含 <strong id="newCollectionDatasetCount">0</strong> 个数据集</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('createCollectionFromTaskModal')">取消</button>
                <button class="btn btn-primary" onclick="confirmCreateCollectionFromTask()">创建合集</button>
            </div>
        </div>
    </div>

    <!-- 异常检测详情弹窗 -->
    <div class="modal" id="anomalyDetailModal" onclick="hideModal('anomalyDetailModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>异常检测详情</h3>
                <div class="modal-header-actions">
                    <button class="btn btn-secondary" onclick="exportAnomalyToExcel()">导出Excel</button>
                    <button class="close-btn" onclick="hideModal('anomalyDetailModal')">x</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- 可视化图表区域 -->
                <div class="anomaly-charts-row">
                    <!-- 左侧：题目分布饼图 -->
                    <div class="anomaly-chart-card">
                        <div class="chart-card-title">题目分布</div>
                        <div class="anomaly-pie-container">
                            <div class="anomaly-pie" id="anomalyPieChart">
                                <canvas id="anomalyPieCanvas"></canvas>
                            </div>
                            <div class="anomaly-pie-legend" id="anomalyPieLegend"></div>
                        </div>
                    </div>
                    <!-- 右侧：一致性折线图 -->
                    <div class="anomaly-chart-card anomaly-chart-card-wide">
                        <div class="chart-card-title">题目一致性趋势</div>
                        <div class="anomaly-bar-container" id="anomalyBarChart">
                            <canvas id="anomalyBarCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="anomaly-detail-stats" id="anomalyDetailStats">
                    <div class="anomaly-detail-card anomaly-universal" onclick="filterAnomalyByType('universal_error')">
                        <div class="anomaly-detail-value" id="anomalyDetailUniversal">0</div>
                        <div class="anomaly-detail-label">全员错误</div>
                        <div class="anomaly-detail-severity">严重</div>
                    </div>
                    <div class="anomaly-detail-card anomaly-high" onclick="filterAnomalyByType('high_anomaly')">
                        <div class="anomaly-detail-value" id="anomalyDetailHigh">0</div>
                        <div class="anomaly-detail-label">高异常</div>
                        <div class="anomaly-detail-severity">识别正确-判断错误</div>
                    </div>
                    <div class="anomaly-detail-card anomaly-low" onclick="filterAnomalyByType('low_anomaly')">
                        <div class="anomaly-detail-value" id="anomalyDetailLow">0</div>
                        <div class="anomaly-detail-label">低异常</div>
                        <div class="anomaly-detail-severity">其他错误类型</div>
                    </div>
                    <div class="anomaly-detail-card anomaly-normal" onclick="filterAnomalyByType('')">
                        <div class="anomaly-detail-value" id="anomalyDetailNormal">0</div>
                        <div class="anomaly-detail-label">一致</div>
                        <div class="anomaly-detail-severity">-</div>
                    </div>
                </div>
                
                <!-- 筛选栏 -->
                <div class="anomaly-filter-row">
                    <select id="anomalyTypeFilter" onchange="filterAnomalyList()">
                        <option value="">全部类型</option>
                        <option value="universal_error">全员错误</option>
                        <option value="high_anomaly">高异常</option>
                        <option value="low_anomaly">低异常</option>
                    </select>
                    <select id="anomalyPageFilter" onchange="filterAnomalyList()">
                        <option value="">全部页码</option>
                    </select>
                    <span class="anomaly-filter-count" id="anomalyFilterCount">显示 0 条</span>
                </div>
                
                <!-- 异常列表 -->
                <div class="anomaly-list-container">
                    <table class="anomaly-table">
                        <thead>
                            <tr>
                                <th style="width:90px">类型</th>
                                <th style="width:90px">位置</th>
                                <th style="width:80px">错误率</th>
                                <th style="width:80px">统计</th>
                                <th>说明</th>
                                <th style="width:30px"></th>
                            </tr>
                        </thead>
                        <tbody id="anomalyTableBody">
                            <tr><td colspan="6" class="empty-row">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示词配置弹窗 -->
    <div class="modal" id="promptConfigModal" onclick="hideModal('promptConfigModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()" style="max-width: 900px;">
            <div class="modal-header">
                <h3>提示词配置管理</h3>
                <button class="close-btn" onclick="hideModal('promptConfigModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- 学科选择 -->
                <div class="prompt-config-tabs">
                    <button class="prompt-tab active" data-subject="1" onclick="switchPromptSubject(1)">语文</button>
                    <button class="prompt-tab" data-subject="0" onclick="switchPromptSubject(0)">英语</button>
                    <button class="prompt-tab" data-subject="3" onclick="switchPromptSubject(3)">物理</button>
                    <button class="prompt-tab" data-subject="4" onclick="switchPromptSubject(4)">化学</button>
                    <button class="prompt-tab" data-subject="5" onclick="switchPromptSubject(5)">生物</button>
                    <button class="prompt-tab" data-subject="6" onclick="switchPromptSubject(6)">地理</button>
                    <button class="prompt-tab" data-subject="2" onclick="switchPromptSubject(2)">数学</button>
                </div>
                
                <!-- 操作按钮 -->
                <div class="prompt-config-actions">
                    <button class="btn btn-primary" onclick="checkAllPromptChanges()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        一键检测所有学科
                    </button>
                    <button class="btn btn-secondary" onclick="syncAllPromptConfigs()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
                            <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"></path>
                        </svg>
                        同步所有变更
                    </button>
                </div>
                
                <!-- 提示词列表 -->
                <div class="prompt-config-list" id="promptConfigList">
                    <div class="empty-state">
                        <div class="empty-state-text">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('promptConfigModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 提示词详情弹窗 -->
    <div class="modal" id="promptDetailModal" onclick="hideModal('promptDetailModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 id="promptDetailTitle">提示词详情</h3>
                <button class="close-btn" onclick="hideModal('promptDetailModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                <!-- 版本信息 -->
                <div class="prompt-detail-meta" id="promptDetailMeta"></div>
                
                <!-- 版本历史 -->
                <div class="prompt-versions-section">
                    <div class="section-title" style="font-size: 14px; margin-bottom: 12px;">版本历史</div>
                    <div class="prompt-versions-list" id="promptVersionsList"></div>
                </div>
                
                <!-- 当前内容 -->
                <div class="prompt-content-section">
                    <div class="section-title" style="font-size: 14px; margin-bottom: 12px;">当前提示词内容</div>
                    <pre class="prompt-content-preview" id="promptContentPreview"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('promptDetailModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 分数图表模块 -->
    <script src="/static/js/modules/score-charts.js?v=1"></script>
    <script src="/static/js/modules/score-accuracy.js?v=1"></script>
    
    <!-- 主 JS 文件 -->
    <script src="/static/js/batch-evaluation.js?v=13"></script>
    
    <!-- Chart.js 和 html2canvas 按需加载 -->
    <script>
    // 延迟加载 Chart.js（仅在需要图表时加载）
    window.loadChartJS = function() {
        return new Promise((resolve, reject) => {
            if (window.Chart) { resolve(window.Chart); return; }
            const script = document.createElement('script');
            script.src = 'https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
            script.onload = () => resolve(window.Chart);
            script.onerror = reject;
            document.head.appendChild(script);
        });
    };
    // 延迟加载 html2canvas（仅在导出时加载）
    window.loadHtml2Canvas = function() {
        return new Promise((resolve, reject) => {
            if (window.html2canvas) { resolve(window.html2canvas); return; }
            const script = document.createElement('script');
            script.src = 'https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = () => resolve(window.html2canvas);
            script.onerror = reject;
            document.head.appendChild(script);
        });
    };
    </script>
</body>
</html>
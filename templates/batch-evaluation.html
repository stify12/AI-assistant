<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量评估</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/batch-evaluation.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">批量评估</div>
        <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn btn-secondary" onclick="showSettingsModal()">设置</button>
            <button class="back-btn" onclick="goBack()">返回</button>
        </div>
    </nav>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">处理中...</div>
    </div>

    <!-- Tab切换 -->
    <div class="tab-container">
        <div class="tabs">
            <div class="tab active" data-tab="tasks">任务管理</div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-layout">
        <!-- 任务管理视图 -->
        <div class="view-container" id="tasksView">
            <!-- 左侧面板 - 任务列表 -->
            <div class="left-panel">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">评估任务</div>
                        <button class="btn btn-primary" onclick="showCreateTaskModal()">新建任务</button>
                    </div>
                    <!-- 学科筛选下拉 + 测试条件筛选 -->
                    <div class="filter-row" style="margin-bottom: 12px;">
                        <div class="form-group" style="flex: 1;">
                            <label>学科筛选</label>
                            <select id="taskSubjectFilter" onchange="onTaskFilterChange()">
                                <option value="">全部学科</option>
                                <option value="0">英语</option>
                                <option value="1">语文</option>
                                <option value="2">数学</option>
                                <option value="3">物理</option>
                                <option value="4">化学</option>
                                <option value="5">生物</option>
                                <option value="6">地理</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>测试条件</label>
                            <select id="taskConditionFilter" onchange="onTaskFilterChange()">
                                <option value="">全部条件</option>
                            </select>
                        </div>
                    </div>
                    <div class="task-list" id="taskList">
                        <div class="empty-state">
                            <div class="empty-state-icon">--</div>
                            <div class="empty-state-text">暂无评估任务</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板 - 任务详情 -->
            <div class="right-panel">
                <div class="empty-right-panel" id="emptyTaskDetail">
                    <div class="empty-state">
                        <div class="empty-state-icon">--</div>
                        <div class="empty-state-text">请从左侧选择任务</div>
                    </div>
                </div>
                <div class="task-detail" id="taskDetail" style="display:none;">
                    <div class="section">
                        <div class="section-header">
                            <div>
                                <div class="section-title" id="taskDetailTitle">任务详情</div>
                                <div class="section-desc" id="taskDetailMeta"></div>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-secondary" id="startEvalBtn" onclick="startBatchEvaluation()">本地评估</button>
                                <button class="btn btn-primary" id="batchAiEvalBtn" onclick="batchAiEvaluation()">一键AI评估</button>
                                <button class="btn btn-secondary" id="reEvalBtn" onclick="reEvaluateCurrentTask()" style="display:none;">重新评估</button>
                                <button class="btn btn-secondary" id="exportBtn" onclick="exportExcel()" disabled>导出Excel</button>
                                <button class="btn btn-secondary" id="aiReportBtn" onclick="generateAIReport()" disabled>AI分析</button>
                                <button class="btn btn-warning" id="resetTaskBtn" onclick="resetBatchTask()" style="display:none;">重置任务</button>
                                <button class="btn btn-danger" onclick="deleteCurrentTask()">删除任务</button>
                            </div>
                        </div>
                        
                        <!-- 评估进度 -->
                        <div class="progress-container" id="progressContainer" style="display:none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0/0</div>
                        </div>

                        <!-- 总体报告 -->
                        <div class="overall-report" id="overallReport" style="display:none;">
                            <!-- 测试条件信息 -->
                            <div class="test-conditions-info" id="testConditionsInfo" style="display:none;"></div>
                            <div class="report-title">总体报告</div>
                            <div class="stats-grid" id="overallStats"></div>
                            
                            <!-- 可视化图表 -->
                            <div class="charts-container" id="chartsContainer">
                                <div class="chart-grid">
                                    <div class="chart-box">
                                        <div class="chart-title">错误类型分布</div>
                                        <canvas id="errorTypePieChart"></canvas>
                                    </div>
                                    <div class="chart-box">
                                        <div class="chart-title">题型准确率对比</div>
                                        <canvas id="typeBarChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-grid">
                                    <div class="chart-box">
                                        <div class="chart-title">高频错误题目 TOP5</div>
                                        <canvas id="errorTrendChart"></canvas>
                                    </div>
                                    <div class="chart-box">
                                        <div class="chart-title">准确率分析</div>
                                        <div class="accuracy-progress-container" id="accuracyProgressContainer">
                                            <div class="accuracy-progress-item" onclick="showAccuracyDetail('recognition')">
                                                <div class="accuracy-progress-header">
                                                    <span class="accuracy-progress-label">识别准确率</span>
                                                    <span class="accuracy-progress-value" id="recognitionRateValue">-</span>
                                                </div>
                                                <div class="accuracy-progress-bar">
                                                    <div class="accuracy-progress-fill recognition-fill" id="recognitionProgressFill"></div>
                                                </div>
                                                <div class="accuracy-progress-stats" id="recognitionStats">正确 0 / 总计 0</div>
                                            </div>
                                            <div class="accuracy-progress-item" onclick="showAccuracyDetail('grading')">
                                                <div class="accuracy-progress-header">
                                                    <span class="accuracy-progress-label">批改准确率</span>
                                                    <span class="accuracy-progress-value" id="gradingRateValue">-</span>
                                                </div>
                                                <div class="accuracy-progress-bar">
                                                    <div class="accuracy-progress-fill grading-fill" id="gradingProgressFill"></div>
                                                </div>
                                                <div class="accuracy-progress-stats" id="gradingStats">正确 0 / 总计 0</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stats-detail" id="statsDetail"></div>
                        </div>

                        <!-- 作业列表 -->
                        <div class="homework-list-container">
                            <div class="list-header">作业任务列表</div>
                            <div class="homework-list" id="homeworkList"></div>
                        </div>

                        <!-- AI分析报告 -->
                        <div class="ai-report" id="aiReport" style="display:none;">
                            <div class="report-title">AI分析报告</div>
                            <div class="report-content" id="aiReportContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据集管理视图已移至学科评估页面 -->
    </div>

    <!-- 新建任务弹窗 -->
    <div class="modal" id="createTaskModal" onclick="hideModal('createTaskModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>新建评估任务</h3>
                <button class="close-btn" onclick="hideModal('createTaskModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>任务名称</label>
                    <input type="text" id="taskNameInput" placeholder="输入任务名称">
                </div>
                <div class="filter-row">
                    <div class="form-group">
                        <label>学科</label>
                        <select id="hwSubjectFilter" onchange="onSubjectFilterChange()">
                            <option value="">全部学科</option>
                            <option value="0">英语</option>
                            <option value="1">语文</option>
                            <option value="2">数学</option>
                            <option value="3">物理</option>
                            <option value="4">化学</option>
                            <option value="5">生物</option>
                            <option value="6">地理</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>测试条件</label>
                        <div class="condition-select-wrapper">
                            <select id="hwConditionSelect" onchange="onConditionSelectChange()">
                                <option value="">请选择测试条件</option>
                            </select>
                            <div class="condition-add-row" id="conditionAddRow" style="display: none;">
                                <input type="text" id="newConditionInput" placeholder="输入新测试条件名称">
                                <button class="btn btn-small btn-primary" onclick="saveNewCondition()">保存</button>
                                <button class="btn btn-small btn-secondary" onclick="cancelAddCondition()">取消</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="fuzzyThresholdGroup" style="display: none;">
                        <label>模糊匹配阈值</label>
                        <div class="threshold-input-wrapper">
                            <input type="range" id="fuzzyThresholdInput" min="50" max="100" value="85" oninput="updateThresholdDisplay()">
                            <span id="fuzzyThresholdValue">85%</span>
                        </div>
                        <div class="form-hint">语文主观题相似度达到此阈值视为匹配</div>
                    </div>
                    <div class="form-group">
                        <label>时间范围</label>
                        <select id="hwTimeFilter" onchange="onTimeFilterChange()">
                            <option value="1">最近1小时</option>
                            <option value="3">最近3小时</option>
                            <option value="6" selected>最近6小时</option>
                            <option value="12">最近12小时</option>
                            <option value="24">最近24小时</option>
                            <option value="72">最近3天</option>
                            <option value="168">最近7天</option>
                        </select>
                    </div>
                </div>
                
                <!-- 作业任务筛选 -->
                <div class="task-filter-section">
                    <div class="task-filter-header">
                        <span class="task-filter-label">按作业任务筛选（可多选）</span>
                        <button class="btn btn-small btn-secondary" onclick="loadHomeworkTasksForFilter()">刷新任务</button>
                    </div>
                    <div class="task-list" id="hwTaskList">
                        <div class="task-loading">加载中...</div>
                    </div>
                    <!-- 任务统计信息 -->
                    <div id="taskStatsInfo" style="display: none;"></div>
                </div>
                
                <div class="selection-info">
                    <span>已选择 <strong id="selectedCount">0</strong> 个作业</span>
                    <button class="btn btn-small" onclick="selectAllHomework()">全选</button>
                    <button class="btn btn-small btn-secondary" onclick="clearHomeworkSelection()">清空</button>
                </div>
                <div class="homework-select-list" id="homeworkSelectList">
                    <div class="empty-state">
                        <div class="empty-state-text">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('createTaskModal')">取消</button>
                <button class="btn btn-primary" onclick="createTask()">创建任务</button>
            </div>
        </div>
    </div>

    <!-- 添加数据集弹窗 -->
    <div class="modal" id="addDatasetModal" onclick="hideModal('addDatasetModal', event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>添加数据集</h3>
                <button class="close-btn" onclick="hideModal('addDatasetModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择页码</label>
                    <div class="page-select-list" id="pageSelectList"></div>
                </div>
                <div class="form-group">
                    <label>基准效果配置</label>
                    <div class="base-effect-config" id="baseEffectConfig">
                        <div class="empty-state">
                            <div class="empty-state-text">请先选择页码</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('addDatasetModal')">取消</button>
                <button class="btn btn-primary" onclick="saveDataset()">保存数据集</button>
            </div>
        </div>
    </div>

    <!-- 评估详情抽屉 -->
    <div class="drawer" id="evalDetailDrawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 id="evalDetailTitle">评估详情</h3>
                <button class="close-btn" onclick="hideDrawer()">x</button>
            </div>
            <div class="drawer-body" id="evalDetailBody">
                <!-- 评估详情内容 -->
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h3>评估设置</h3>
                <button class="close-btn" onclick="hideSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 模糊匹配阈值设置 -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        <div class="settings-section-title">模糊匹配阈值</div>
                        <div class="settings-section-badge">语文主观题</div>
                    </div>
                    <div class="settings-slider-group">
                        <input type="range" id="settingsFuzzyThreshold" class="settings-slider" min="50" max="100" value="85" oninput="updateSettingsThresholdDisplay()">
                        <div class="settings-slider-value" id="settingsFuzzyThresholdValue">85%</div>
                    </div>
                    <div class="settings-hint">相似度达到此阈值视为匹配，不计入错误</div>
                </div>
                
                <!-- 题号前缀设置 -->
                <div class="settings-section">
                    <label class="settings-checkbox-label">
                        <input type="checkbox" id="settingsIgnoreIndexPrefix" class="settings-checkbox" checked>
                        <span class="settings-checkbox-custom"></span>
                        <div class="settings-checkbox-content">
                            <div class="settings-checkbox-title">忽略题号前缀差异</div>
                            <div class="settings-checkbox-desc">如 "(1)答案" 与 "答案" 视为相同</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSettingsModal()">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <!-- 数据集选择弹窗 -->
    <div class="modal" id="datasetSelectorModal" onclick="hideModal('datasetSelectorModal', event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>选择数据集</h3>
                <button class="close-btn" onclick="hideModal('datasetSelectorModal')">x</button>
            </div>
            <div class="modal-body">
                <div class="selector-info" id="selectorInfo">
                    <!-- 显示当前作业信息 -->
                </div>
                <div class="dataset-selector-list" id="matchingDatasetList">
                    <div class="empty-state">
                        <div class="empty-state-text">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('datasetSelectorModal')">取消</button>
                <button class="btn btn-primary" id="confirmDatasetBtn" onclick="confirmDatasetSelection()" disabled>确认选择</button>
            </div>
        </div>
    </div>

    <script src="/static/js/batch-evaluation.js?v=4"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 助手</title>
    <!-- 预加载关键资源 -->
    <link rel="preload" href="/static/css/common.css?v=20260124" as="style">
    <link rel="preload" href="/static/css/chat.css?v=20260124" as="style">
    <link rel="preload" href="/static/js/chat.js?v=20260124" as="script">
    <!-- 样式表 -->
    <link rel="stylesheet" href="/static/css/common.css?v=20260124">
    <link rel="stylesheet" href="/static/css/chat.css?v=20260124">
    <!-- 第三方库延迟加载 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/9.1.6/marked.min.js" defer></script>
</head>
<body>
    <!-- 左侧快捷入口栏（初始状态）/ 历史对话栏（对话状态） -->
    <aside class="sidebar" id="sidebar">
        <!-- 快捷入口视图（初始状态显示） -->
        <div class="sidebar-welcome" id="sidebarWelcome">
            <div class="sidebar-brand">
                <div class="brand-icon">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                </div>
                <span class="brand-text">AI 效果分析</span>
            </div>
            
            <div class="nav-section">
                <div class="nav-label">核心功能</div>
                <a href="/subject-grading" class="nav-card featured">
                    <div class="nav-card-icon">
                        <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    </div>
                    <div class="nav-card-body">
                        <div class="nav-card-title">学科批改评估</div>
                        <div class="nav-card-desc">多学科作业批改效果分析</div>
                    </div>
                    <svg class="nav-card-arrow" viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </a>
                <a href="/batch-evaluation" class="nav-card">
                    <div class="nav-card-icon">
                        <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/></svg>
                    </div>
                    <div class="nav-card-body">
                        <div class="nav-card-title">批量评估</div>
                        <div class="nav-card-desc">批量对比AI批改结果</div>
                    </div>
                    <svg class="nav-card-arrow" viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-label">工具</div>
                <div class="nav-tools-compact">
                    <a href="/knowledge-agent" class="nav-tool-item" title="知识点类题">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3z"/></svg>
                        <span>知识点</span>
                    </a>
                    <a href="/data-analysis" class="nav-tool-item" title="数据分析">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                        <span>分析</span>
                    </a>
                    <a href="/prompt-optimize" class="nav-tool-item" title="提示词优化">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"/></svg>
                        <span>提示词</span>
                    </a>
                    <a href="/dataset-manage" class="nav-tool-item" title="数据集管理">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>
                        <span>数据集</span>
                    </a>
                </div>
            </div>
            
            <!-- 优化日志 -->
            <div class="nav-section opt-logs-section">
                <div class="nav-label">
                    <span>优化日志</span>
                    <button class="add-log-btn" onclick="showAddLogModal()" title="添加日志">+</button>
                </div>
                <div class="opt-logs-list" id="optLogsList">
                    <div class="opt-logs-empty">暂无日志</div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="footer-btn" onclick="showSettings()">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                    设置
                </button>
            </div>
        </div>
        
        <!-- 历史对话视图（对话状态显示） -->
        <div class="sidebar-history" id="sidebarHistory" style="display:none;">
            <div class="history-header">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    新对话
                </button>
                <button class="toggle-history-btn" onclick="toggleHistorySidebar()">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>
            </div>
            <div class="history-search">
                <input type="text" id="historySearch" placeholder="搜索对话..." oninput="filterHistory()">
            </div>
            <div class="history-list" id="historyList"></div>
            
            <!-- 底部快捷入口（折叠状态） -->
            <div class="history-quick-nav">
                <a href="/subject-grading" class="quick-nav-btn" title="学科批改评估">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                </a>
                <a href="/batch-evaluation" class="quick-nav-btn" title="批量评估">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l4.59-4.58L18 11l-6 6z"/></svg>
                </a>
                <a href="/knowledge-agent" class="quick-nav-btn" title="知识点类题">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3z"/></svg>
                </a>
                <a href="/data-analysis" class="quick-nav-btn" title="数据分析">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                </a>
                <button class="quick-nav-btn" onclick="showSettings()" title="设置">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- 主内容区 -->
    <div class="main-wrapper" id="mainWrapper">
        <!-- 顶部栏 -->
        <header class="top-bar">
            <button class="menu-btn" onclick="toggleHistorySidebar()">
                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <div class="model-selector">
                <select id="currentModelSelect" onchange="onModelSelectChange()">
                    <optgroup label="视觉识别">
                        <option value="doubao-1-5-vision-pro-32k-250115">Vision Pro</option>
                        <option value="doubao-seed-1-6-vision-250815">Seed Vision</option>
                        <option value="doubao-seed-1-6-251015">Seed 1.6</option>
                        <option value="doubao-seed-1-8-251228">Seed 1.8</option>
                        <option value="doubao-seed-1-6-thinking-250715">Seed Thinking</option>
                        <option value="qwen-vl-plus">Qwen VL</option>
                    </optgroup>
                    <optgroup label="日常聊天">
                        <option value="gpt-5-chat-latest">GPT-5 Chat</option>
                        <option value="gpt-5.2">GPT-5.2</option>
                        <option value="gpt-5.1">GPT-5.1</option>
                        <option value="gpt-5-mini">GPT-5 Mini</option>
                        <option value="gpt-4.1">GPT-4.1</option>
                        <option value="grok-4">Grok-4</option>
                        <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
                        <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
                        <option value="gemini-3-flash-preview-nothinking">Gemini 3 Flash NoThink</option>
                        <option value="gemini-3-flash-preview-thinking">Gemini 3 Flash Think</option>
                        <option value="deepseek-v3.2">DeepSeek V3.2</option>
                    </optgroup>
                </select>
            </div>
            <button class="tools-btn" onclick="toggleToolsSidebar()">工具</button>
            <button class="first-principles-btn" id="firstPrinciplesBtn" onclick="toggleFirstPrinciplesMode()">第一性原理</button>
            <!-- 用户头像按钮 -->
            <div class="user-avatar-wrapper" id="userAvatarWrapper">
                <button class="user-avatar-btn" id="userAvatarBtn" onclick="toggleUserMenu()">
                    <svg class="avatar-icon" id="avatarIcon" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span class="avatar-letter" id="avatarLetter" style="display:none;"></span>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header" id="userDropdownHeader"></div>
                    <button class="user-dropdown-item" onclick="handleLogout()">退出登录</button>
                </div>
            </div>
        </header>

        <!-- 对话内容区 -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-welcome" id="chatWelcome">
                <h1 id="welcomeTitle">有什么可以帮你的?</h1>
                <p id="welcomeDesc">选择模型开始对话，支持图片识别与日常聊天</p>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
        </div>

        <!-- 输入区域 -->
        <div class="input-area">
            <!-- 思考程度选择器 -->
            <div class="reasoning-selector" id="reasoningSelector" style="display:none;">
                <span class="reasoning-label">思考程度:</span>
                <div class="reasoning-options">
                    <button class="reasoning-btn" data-level="minimal" onclick="setReasoningLevel('minimal')">不思考</button>
                    <button class="reasoning-btn" data-level="low" onclick="setReasoningLevel('low')">低</button>
                    <button class="reasoning-btn active" data-level="medium" onclick="setReasoningLevel('medium')">中</button>
                    <button class="reasoning-btn" data-level="high" onclick="setReasoningLevel('high')">高</button>
                </div>
            </div>
            <div class="input-box">
                <div class="input-preview" id="inputPreview" style="display:none;">
                    <img id="inputPreviewImg">
                    <button class="preview-remove" onclick="removeInputImage()">×</button>
                </div>
                <div class="input-row">
                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="上传图片">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <textarea id="promptInput" placeholder="输入消息..." rows="1"></textarea>
                    <div class="parallel-input-wrapper" title="并行处理次数">
                        <input type="number" id="parallelCount" min="1" max="10" value="1" class="parallel-input">
                        <span class="parallel-suffix">x</span>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧工具栏 -->
    <aside class="tools-sidebar" id="toolsSidebar">
        <div class="tools-header">
            <h3>工具箱</h3>
            <button class="tools-close" onclick="toggleToolsSidebar()">×</button>
        </div>
        
        <!-- MCP工具管理 -->
        <div class="tools-section">
            <div class="tools-label">联网搜索</div>
            <div class="mcp-tool-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="useToolsToggle" checked onchange="toggleUseTools()">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">自动联网</span>
            </div>
            <div class="mcp-tools-list" id="mcpToolsList"></div>
            <button class="tools-add-btn" onclick="showAddMcpTool()">+ 添加HTTP工具</button>
        </div>
        
        <div class="tools-divider"></div>
        
        <!-- MCP服务器管理 -->
        <div class="tools-section">
            <div class="tools-label">MCP 服务器</div>
            <div class="mcp-servers-list" id="mcpServersList"></div>
            <button class="tools-add-btn" onclick="showAddMcpServer()">+ 添加MCP服务器</button>
        </div>
        
        <div class="tools-divider"></div>
        
        <div class="tools-section">
            <div class="tools-label">题号识别</div>
            <textarea class="tools-textarea" id="extractPrompt" rows="3" placeholder="自定义识别提示词...">识别图片中每道题目的题号和前15个字符，输出JSON数组：[{"index":"题号","content":"内容"}]</textarea>
            <div class="tools-upload" id="extractUploadZone" onclick="document.getElementById('extractFileInput').click()">
                点击上传图片
            </div>
            <input type="file" id="extractFileInput" accept="image/*" hidden>
            <div class="tools-preview" id="extractPreview" style="display:none;">
                <img id="extractPreviewImg">
                <button onclick="removeExtractImage()">×</button>
            </div>
            <button class="tools-action-btn" id="startExtractBtn" onclick="startExtract()" disabled>开始识别</button>
            <div class="tools-result" id="questionsResult"></div>
        </div>
        
        <div class="tools-divider"></div>
        
        <div class="tools-section">
            <div class="tools-label">提示词模板</div>
            <div class="tools-prompt-list" id="promptList"></div>
            <button class="tools-add-btn" onclick="showAddPrompt()">+ 添加模板</button>
        </div>
    </aside>

    <!-- MCP工具编辑弹窗 -->
    <div class="modal" id="mcpToolModal">
        <div class="modal-content" style="max-width:480px;">
            <h3 id="mcpToolModalTitle">添加自定义工具</h3>
            <div class="form-group">
                <label>工具名称</label>
                <input type="text" id="mcpToolName" placeholder="例如：天气查询">
            </div>
            <div class="form-group">
                <label>工具描述</label>
                <input type="text" id="mcpToolDesc" placeholder="描述工具的功能，模型会根据此判断何时调用">
            </div>
            <div class="form-group">
                <label>API 地址</label>
                <input type="text" id="mcpToolUrl" placeholder="https://api.example.com/search">
            </div>
            <div class="form-group">
                <label>请求方法</label>
                <select id="mcpToolMethod">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideMcpToolModal()">取消</button>
                <button class="btn-save" onclick="saveMcpTool()">保存</button>
            </div>
        </div>
    </div>

    <!-- MCP服务器配置弹窗 -->
    <div class="modal" id="mcpServerModal">
        <div class="modal-content" style="max-width:520px;">
            <h3>添加 MCP 服务器</h3>
            <div class="form-group">
                <label>服务器名称</label>
                <input type="text" id="mcpServerName" placeholder="例如：trends-hub">
            </div>
            <div class="form-group">
                <label>启动命令</label>
                <input type="text" id="mcpServerCommand" value="npx" placeholder="npx / uvx / node">
            </div>
            <div class="form-group">
                <label>命令参数（每行一个）</label>
                <textarea id="mcpServerArgs" rows="3" placeholder="-y&#10;mcp-trends-hub@1.6.0"></textarea>
            </div>
            <div class="form-group">
                <label>环境变量（JSON格式，可选）</label>
                <textarea id="mcpServerEnv" rows="2" placeholder='{"API_KEY": "xxx"}'></textarea>
            </div>
            <div class="mcp-config-hint">
                <p>示例配置：</p>
                <pre>命令: npx
参数:
-y
mcp-trends-hub@1.6.0</pre>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideMcpServerModal()">取消</button>
                <button class="btn-save" onclick="saveMcpServer()">保存</button>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>系统设置</h3>
            
            <!-- 设置标签页 -->
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('api')">API 密钥</button>
                <button class="settings-tab" onclick="switchSettingsTab('database')">数据库</button>
            </div>
            
            <!-- API 密钥配置 -->
            <div class="settings-panel" id="settingsPanel_api">
                <div class="settings-section">
                    <div class="settings-section-title">
                        豆包 API（视觉识别）
                        <a href="https://console.volcengine.com/ark" target="_blank" class="api-link">获取密钥</a>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="apiKey" placeholder="输入豆包 API Key">
                    </div>
                    <div class="form-group">
                        <label>API URL</label>
                        <input type="text" id="apiUrl" value="https://ark.cn-beijing.volces.com/api/v3/chat/completions">
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">
                        GPT API（日常聊天）
                        <a href="https://api.gpt.ge" target="_blank" class="api-link">获取密钥</a>
                    </div>
                    <div class="form-group">
                        <label>GPT API Key</label>
                        <input type="password" id="gptApiKey" placeholder="输入 GPT API Key">
                    </div>
                    <div class="form-group">
                        <label>GPT API URL</label>
                        <input type="text" id="gptApiUrl" value="https://api.gpt.ge/v1/chat/completions">
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">
                        DeepSeek（评估分析）
                        <a href="https://platform.deepseek.com" target="_blank" class="api-link">获取密钥</a>
                    </div>
                    <div class="form-group">
                        <label>DeepSeek API Key</label>
                        <input type="password" id="deepseekApiKey" placeholder="输入 DeepSeek API Key">
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">
                        通义千问（可选）
                        <a href="https://dashscope.console.aliyun.com" target="_blank" class="api-link">获取密钥</a>
                    </div>
                    <div class="form-group">
                        <label>Qwen API Key</label>
                        <input type="password" id="qwenApiKey" placeholder="输入 DashScope API Key">
                    </div>
                </div>
            </div>
            
            <!-- 数据库配置 -->
            <div class="settings-panel" id="settingsPanel_database" style="display:none;">
                <!-- 主数据库配置已移至服务器环境变量 -->
                <input type="hidden" id="mysqlHost">
                <input type="hidden" id="mysqlPort" value="3306">
                <input type="hidden" id="mysqlUser">
                <input type="hidden" id="mysqlPassword">
                <input type="hidden" id="mysqlDatabase">
                
                <div class="settings-section">
                    <div class="settings-section-title">应用数据库（存储评估结果）</div>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;">
                            <label>主机地址</label>
                            <input type="text" id="appMysqlHost" placeholder="留空则不使用">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>端口</label>
                            <input type="number" id="appMysqlPort" value="3306">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>用户名</label>
                            <input type="text" id="appMysqlUser" placeholder="数据库用户名">
                        </div>
                        <div class="form-group">
                            <label>密码</label>
                            <input type="password" id="appMysqlPassword" placeholder="数据库密码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>数据库名</label>
                        <input type="text" id="appMysqlDatabase" placeholder="数据库名称">
                    </div>
                    <button class="btn-test" onclick="testDatabaseConnection('app')">测试连接</button>
                </div>
            </div>
            
            <div class="settings-status" id="settingsStatus"></div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideSettings()">取消</button>
                <button class="btn-save" onclick="saveSettings()">保存配置</button>
            </div>
        </div>
    </div>

    <!-- 提示词编辑弹窗 -->
    <div class="modal" id="promptModal">
        <div class="modal-content" style="max-width:520px;">
            <h3 id="promptModalTitle">添加提示词模板</h3>
            <div class="form-group">
                <label>模板名称</label>
                <input type="text" id="newPromptName" placeholder="例如：答案识别">
            </div>
            <div class="form-group">
                <label>提示词内容</label>
                <textarea id="newPromptContent" rows="10" placeholder="直接输入提示词内容..."></textarea>
            </div>
            <div class="optimize-row">
                <button class="optimize-btn" id="optimizeBtn" onclick="optimizePrompt()">AI优化</button>
                <span class="optimize-hint">使用 Qwen3-Max 优化提示词</span>
            </div>
            <div id="optimizeResult" class="optimize-result" style="display:none;">
                <div class="optimize-result-header">
                    <span>优化建议</span>
                    <button class="apply-btn" onclick="applyOptimizedPrompt()">应用</button>
                </div>
                <div id="optimizeContent" class="optimize-content"></div>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideAddPrompt()">取消</button>
                <button class="btn-save" onclick="savePrompt()">保存</button>
            </div>
        </div>
    </div>

    <!-- 图片放大弹窗 -->
    <div class="image-modal" id="imageModal" onclick="hideImageModal()">
        <img id="modalImg" src="">
    </div>

    <!-- 登录弹窗 -->
    <div class="modal" id="loginModal">
        <div class="modal-content login-modal-content">
            <h3>登录</h3>
            <p class="login-hint">没有账号？输入用户名密码自动注册</p>
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="loginUsername" placeholder="请输入用户名" autocomplete="username">
            </div>
            <div class="form-group">
                <label>密码</label>
                <input type="password" id="loginPassword" placeholder="请输入密码" autocomplete="current-password">
            </div>
            <div class="form-group remember-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="loginRemember" checked>
                    <span>记住登录</span>
                </label>
            </div>
            <div class="login-error" id="loginError" style="display:none;"></div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideLoginModal()">取消</button>
                <button class="btn-save login-btn" id="loginBtn" onclick="handleLogin()">登录</button>
            </div>
        </div>
    </div>

    <!-- 添加优化日志弹窗 -->
    <div class="modal" id="addLogModal">
        <div class="modal-content" style="max-width:400px;">
            <h3>添加优化日志</h3>
            <div class="form-row">
                <div class="form-group" style="flex:2;">
                    <label>日期</label>
                    <input type="date" id="logDate">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>时间</label>
                    <input type="time" id="logTime">
                </div>
            </div>
            <div class="form-group">
                <label>分类</label>
                <select id="logCategory">
                    <option value="general">通用</option>
                    <option value="accuracy">准确率</option>
                    <option value="performance">性能</option>
                    <option value="feature">功能</option>
                </select>
            </div>
            <div class="form-group">
                <label>内容</label>
                <textarea id="logContent" rows="3" placeholder="例如：优化了物理学科批改准确率"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideAddLogModal()">取消</button>
                <button class="btn-save" onclick="saveOptLog()">保存</button>
            </div>
        </div>
    </div>

    <!-- 查看日志详情弹窗 -->
    <div class="modal" id="viewLogModal">
        <div class="modal-content log-detail-modal">
            <div class="log-detail-header">
                <span class="log-detail-date" id="viewLogDate"></span>
                <span class="log-detail-category" id="viewLogCategory"></span>
                <button class="modal-close" onclick="hideViewLogModal()">&times;</button>
            </div>
            <div class="log-detail-content" id="viewLogContent"></div>
        </div>
    </div>

    <script src="/static/js/chat.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据集管理</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/dataset-manage.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">数据集管理</div>
        <div style="display:flex;gap:12px;align-items:center;">
            <button class="back-btn" onclick="goBack()">返回</button>
        </div>
    </nav>

    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">处理中...</div>
    </div>

    <!-- 主布局 -->
    <div class="main-layout">
        <!-- 左侧 - 图书列表 -->
        <div class="left-panel">
            <div class="panel-header">
                <div class="panel-title">图书列表</div>
            </div>
            <div class="filter-section">
                <select id="subjectFilter" onchange="filterBooks()">
                    <option value="">全部学科</option>
                    <option value="0">英语</option>
                    <option value="1">语文</option>
                    <option value="2">数学</option>
                    <option value="3">物理</option>
                    <option value="4">化学</option>
                    <option value="5">生物</option>
                    <option value="6">地理</option>
                </select>
                <input type="text" id="bookSearchInput" placeholder="搜索书名..." oninput="filterBooks()">
            </div>
            <div class="book-list" id="bookList">
                <div class="empty-state">
                    <div class="empty-state-text">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 右侧 - 详情区域 -->
        <div class="right-panel">
            <!-- 数据集概览 - 默认显示 -->
            <div class="dataset-overview" id="datasetOverview">
                <div class="overview-header">
                    <div class="overview-title">数据集概览</div>
                    <div class="overview-stats" id="overviewStats"></div>
                </div>
                <div class="overview-book-list" id="overviewBookList">
                    <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                </div>
            </div>

            <!-- 空状态 - 隐藏 -->
            <div class="empty-right" id="emptyRight" style="display:none;">
                <div class="empty-state">
                    <div class="empty-state-icon">--</div>
                    <div class="empty-state-text">请从左侧选择图书</div>
                </div>
            </div>

            <!-- 书本详情 -->
            <div class="book-detail" id="bookDetail" style="display:none;">
                <!-- 书本信息头 -->
                <div class="detail-header">
                    <div class="detail-info">
                        <h2 id="bookTitle">书本名称</h2>
                        <div class="detail-meta" id="bookMeta"></div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-secondary" onclick="exportAllDatasets()">导出数据集</button>
                        <button class="btn btn-secondary" onclick="showImportModal()">导入数据集</button>
                        <button class="btn btn-primary" onclick="showAddDatasetPanel()">+ 添加数据集</button>
                    </div>
                </div>

                <!-- 已有数据集列表 -->
                <div class="section">
                    <div class="section-title">已配置数据集</div>
                    <div class="dataset-list" id="datasetList">
                        <div class="empty-state"><div class="empty-state-text">暂无数据集</div></div>
                    </div>
                </div>

                <!-- 页码概览 -->
                <div class="section">
                    <div class="section-title">页码概览</div>
                    <div class="page-overview" id="pageOverview">
                        <div class="empty-state"><div class="empty-state-text">暂无页码数据</div></div>
                    </div>
                </div>
            </div>

            <!-- 添加数据集面板 -->
            <div class="add-dataset-panel" id="addDatasetPanel" style="display:none;">
                <div class="panel-header">
                    <div class="panel-title">添加数据集</div>
                    <button class="btn btn-secondary" onclick="hideAddDatasetPanel()">返回</button>
                </div>

                <!-- 步骤1: 选择页码 -->
                <div class="step-section">
                    <div class="step-header">
                        <span class="step-num">1</span>
                        <span class="step-title">选择页码</span>
                        <div class="step-actions">
                            <input type="text" id="pageRangeInput" placeholder="范围选择，如: 1-10, 15, 20-25" class="range-input">
                            <button class="btn btn-small btn-text" onclick="applyPageRange()">应用</button>
                            <button class="btn btn-small btn-text" onclick="selectAllPages()">全选</button>
                            <button class="btn btn-small btn-text" onclick="clearPageSelection()">清空</button>
                        </div>
                    </div>
                    <div class="page-select-info" id="pageSelectInfo">已选择 0 个页码</div>
                    <div class="page-select-grid" id="pageSelectGrid"></div>
                </div>

                <!-- 步骤2: 选择作业图片进行识别 -->
                <div class="step-section" id="step2Section" style="display:none;">
                    <div class="step-header">
                        <span class="step-num">2</span>
                        <span class="step-title">选择作业图片</span>
                        <div class="step-actions">
                            <select id="timeRangeSelect" onchange="loadAvailableHomework()">
                                <option value="1">最近1小时</option>
                                <option value="6">最近6小时</option>
                                <option value="24" selected>最近24小时</option>
                                <option value="72">最近3天</option>
                                <option value="168">最近7天</option>
                            </select>
                            <button class="btn btn-small" onclick="loadAvailableHomework()">刷新</button>
                        </div>
                    </div>
                    <div class="homework-grid" id="homeworkGrid">
                        <div class="empty-state"><div class="empty-state-text">请先选择页码</div></div>
                    </div>
                </div>

                <!-- 步骤3: 确认基准效果 -->
                <div class="step-section" id="step3Section" style="display:none;">
                    <div class="step-header">
                        <span class="step-num">3</span>
                        <span class="step-title">确认基准效果</span>
                        <button class="btn btn-primary" onclick="startRecognize()">开始识别</button>
                    </div>
                    <div class="recognize-result" id="recognizeResult">
                        <div class="empty-state"><div class="empty-state-text">选择作业图片后点击"开始识别"</div></div>
                    </div>
                </div>

                <!-- 步骤4: 数据集命名 -->
                <div class="step-section" id="step4Section" style="display:none;">
                    <div class="step-header">
                        <span class="step-num">4</span>
                        <span class="step-title">数据集命名</span>
                    </div>
                    <div class="naming-form">
                        <div class="form-group">
                            <label for="datasetNameInput">数据集名称 <span class="required">*</span></label>
                            <input type="text" id="datasetNameInput" placeholder="输入数据集名称，如：学生A基准效果" maxlength="200">
                            <div class="form-hint">名称用于区分不同的数据集，便于后续选择</div>
                        </div>
                        <div class="form-group">
                            <label for="datasetDescInput">描述（可选）</label>
                            <textarea id="datasetDescInput" placeholder="添加备注说明..." maxlength="500" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div class="save-section" id="saveSection" style="display:none;">
                    <button class="btn btn-secondary btn-large" onclick="showEffectCorrectionModal()">效果矫正</button>
                    <button class="btn btn-primary btn-large" onclick="saveDataset()">保存数据集</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览弹窗 -->
    <div class="image-modal" id="imageModal" onclick="hideImageModal()">
        <img id="modalImage" src="">
    </div>

    <!-- 导入数据集弹窗 -->
    <div class="import-modal" id="importModal" onclick="hideImportModal(event)">
        <div class="import-modal-content" onclick="event.stopPropagation()">
            <div class="import-modal-header">
                <h3>导入数据集</h3>
                <button class="close-btn" onclick="hideImportModal()">x</button>
            </div>
            <div class="import-modal-body">
                <div class="form-group">
                    <label>选择JSON文件</label>
                    <input type="file" id="importFileInput" accept=".json" onchange="previewImportFile()">
                </div>
                <div class="import-preview" id="importPreview" style="display:none;">
                    <div class="preview-title">预览</div>
                    <div class="preview-content" id="importPreviewContent"></div>
                </div>
            </div>
            <div class="import-modal-footer">
                <button class="btn btn-secondary" onclick="hideImportModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmImport()" id="confirmImportBtn" disabled>确认导入</button>
            </div>
        </div>
    </div>

    <!-- 编辑数据集弹窗 -->
    <div class="edit-modal" id="editModal" onclick="hideEditModal(event)">
        <div class="edit-modal-content" onclick="event.stopPropagation()">
            <div class="edit-modal-header">
                <h3>编辑数据集</h3>
                <button class="close-btn" onclick="hideEditModal()">x</button>
            </div>
            <div class="edit-modal-body">
                <div class="edit-page-tabs" id="editPageTabs"></div>
                
                <!-- 页面操作区 -->
                <div class="edit-page-actions" id="editPageActions">
                    <div class="page-image-preview" id="pageImagePreview">
                        <img id="pagePreviewImg" src="" alt="页面图片" onclick="showImageModal(this.src)">
                        <div class="no-image-placeholder" id="noImagePlaceholder" style="display:none;">
                            <span>无图片</span>
                        </div>
                    </div>
                    <div class="page-action-buttons">
                        <button class="btn btn-secondary" onclick="showReRecognizePanel()">重新识别</button>
                        <button class="btn btn-danger" onclick="confirmDeletePage()">删除此页</button>
                    </div>
                </div>
                
                <!-- 重新识别面板 -->
                <div class="re-recognize-panel" id="reRecognizePanel" style="display:none;">
                    <div class="re-recognize-header">
                        <span class="re-recognize-title">选择作业图片进行重新识别</span>
                        <div class="re-recognize-controls">
                            <select id="reRecognizeTimeRange" onchange="loadReRecognizeImages()">
                                <option value="24">最近24小时</option>
                                <option value="72">最近3天</option>
                                <option value="168">最近7天</option>
                            </select>
                            <button class="btn btn-small btn-text" onclick="loadReRecognizeImages()">刷新</button>
                        </div>
                    </div>
                    <div class="re-recognize-images" id="reRecognizeImages">
                        <div class="empty-state"><div class="empty-state-text">加载中...</div></div>
                    </div>
                    <div class="re-recognize-footer">
                        <button class="btn btn-secondary" onclick="hideReRecognizePanel()">取消</button>
                        <button class="btn btn-primary" id="startReRecognizeBtn" onclick="startReRecognize()" disabled>开始识别</button>
                    </div>
                </div>
                
                <div class="edit-table-container" id="editTableContainer">
                    <table class="edit-table" id="editTable">
                        <thead>
                            <tr>
                                <th style="width:60px;">题号</th>
                                <th>标准答案</th>
                                <th>学生答案</th>
                                <th style="width:80px;">是否正确</th>
                                <th style="width:50px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="editTableBody"></tbody>
                    </table>
                    <div class="edit-table-actions">
                        <button class="btn-add-row" onclick="addEditRow()">+ 添加题目</button>
                    </div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="btn btn-secondary" onclick="hideEditModal()">取消</button>
                <button class="btn btn-primary" onclick="saveEditDataset()">保存修改</button>
            </div>
        </div>
    </div>

    <!-- 重复检测弹窗 -->
    <div class="duplicate-modal" id="duplicateModal" onclick="hideDuplicateModal(event)">
        <div class="duplicate-modal-content" onclick="event.stopPropagation()">
            <div class="duplicate-modal-header">
                <h3>发现相同页码的数据集</h3>
                <button class="close-btn" onclick="hideDuplicateModal()">x</button>
            </div>
            <div class="duplicate-modal-body">
                <p class="duplicate-warning">以下数据集包含相同的页码范围：</p>
                <div class="duplicate-list" id="duplicateList"></div>
                <p class="duplicate-hint">您可以选择编辑现有数据集，或继续创建新的数据集（适用于不同学生的答案作为基准）。</p>
            </div>
            <div class="duplicate-modal-footer">
                <button class="btn btn-secondary" onclick="editExistingDataset()">编辑现有数据集</button>
                <button class="btn btn-primary" onclick="continueCreateNew()">继续创建新数据集</button>
            </div>
        </div>
    </div>

    <!-- 效果矫正弹窗 -->
    <div class="correction-modal" id="correctionModal" onclick="hideCorrectionModal(event)">
        <div class="correction-modal-content" onclick="event.stopPropagation()">
            <div class="correction-modal-header">
                <h3>效果矫正</h3>
                <div class="correction-header-actions">
                    <span class="correction-summary" id="correctionSummary"></span>
                    <button class="close-btn" onclick="hideCorrectionModal()">x</button>
                </div>
            </div>
            <div class="correction-modal-body">
                <!-- 页码选择标签 -->
                <div class="correction-page-tabs" id="correctionPageTabs"></div>
                
                <!-- 对比区域 -->
                <div class="correction-content">
                    <div class="correction-loading" id="correctionLoading">
                        <div class="spinner"></div>
                        <span>加载AI批改结果...</span>
                    </div>
                    <div class="correction-table-container" id="correctionTableContainer" style="display:none;">
                        <!-- 左右分栏内容由JS动态生成 -->
                    </div>
                    <div class="correction-empty" id="correctionEmpty" style="display:none;">
                        <div class="empty-state-icon">--</div>
                        <div class="empty-state-text">所有题目的tempIndex均已匹配</div>
                    </div>
                </div>
            </div>
            <div class="correction-modal-footer">
                <div class="correction-footer-left"></div>
                <div class="correction-footer-right">
                    <button class="btn btn-secondary" onclick="hideCorrectionModal()">取消</button>
                    <button class="btn btn-primary" onclick="applyCorrectionChanges()">应用修改</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/dataset-manage.js"></script>
</body>
</html>
